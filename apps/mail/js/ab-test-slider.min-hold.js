/*global APP, jQuery, window, document, console, Image, $, Number, JSON, Object */
/**
 * Choose recipients - splittest
 *
 * @autor Krzysztof Platta <kplatta@implix.com>
 */
APP.beta=!0,APP(function(){"use strict";var box=this,$=box.dom||jQuery,accordion;accordion={activeClass:"active",$container:void 0,$items:void 0,$expanders:void 0,$active:void 0,init:function(container){var that=this;container=$(container),this.$container=container,this.$items=container.find("[data-accordion-item]"),this.$active=this.$items.filter(function(){return that.isActive($(this))}),this.$expanders=container.find("[data-expander]"),this.attachEvents()},attachEvents:function(){var that=this;this.$container.find("[data-expand-stop]").bind({click:function(e){e.stopPropagation()}}),this.$expanders.bind({click:function(){that.toggle(that.expanderToGroup(this))}})},toggle:function($item){this.isActive($item)?this.contract($item):this.expand($item)},expand:function($item){$item.addClass(this.activeClass)},contract:function($item){$item.removeClass(this.activeClass)},isActive:function($item){return $item.is("."+this.activeClass)},expanderToGroup:function(expander){return this.$items.filter('[data-group="'+expander.getAttribute("data-expander")+'"]')}},APP.domready(function(){$("ul.accordion").each(function(){Object.create(accordion).init(this),$(this).find(".group-content").each(function(){$(this).css("max-height",$(this).find("ul").outerHeight())})})})}),APP(function(){"use strict";var box=this,$=box.dom||jQuery,recipients,counter,form;counter={$el:void 0,init:function($counterEl){return this.$el=$counterEl,this},dataExpire:function(){box.publish("splittest.chooseRecipients.slider.recipientsDataExpire")},setLoader:function(){this.$el.html('<img src="/images/core/global/default/icons/ajax-loader.gif"/>')},refresh:function(){var that=this,formData;this.setLoader(),formData=$("#choose_recipients_form").serialize().replace(/[^\&=]+?=(&|$)/g,"").replace(/redirect_url=.*?(&|$)/,""),$.post("ajax_split_test_choose_recipients.html"+window.location.search+"&action=counter",formData,function(response){var count;response.error||(count=response.table||"0",that.$el.html(count),window.setTimeout(function(){box.publish("splittest.chooseRecipients.slider.setRecipientsData",Number(count.replace(/\.|,/g,""))||0)},10))},"json")}},recipients={$actionEl:void 0,init:function($actionEl,$counterEl){var that=this;this.$actionEl=$actionEl,this.counter=Object.create(counter).init($counterEl),this.attachEvents(),$.register&&$.register.counterSelfRefresh?this.counter.refresh():window.setTimeout(function(){$('input[type="checkbox"][data-action*="include"]:checked')[0]&&that.counter.dataExpire()},100)},attachEvents:function(){var that=this;this.$actionEl.bind({click:function(e){var data=JSON.evalToObject(this.getAttribute("data-action")),actionName="action"+data.action.ucfirst();"function"==typeof that[actionName]&&(data.dataElement=this,that[actionName](e,data))}})},checkGroupsStatus:function(name){var that=this,nameSelector=name?'="'+name+'"':"";$("[data-group"+nameSelector+"]").each(function(){var $group=$(this),$checkAll=$group.find("[data-id"+nameSelector+"]"),$items=$group.find("input[data-name"+nameSelector+"]:visible"),count=$items.length,countChecked,countDisabled;countChecked=$items.filter(":checked").length,countDisabled=$items.filter(":disabled").length,$checkAll[0].checked=!!countChecked&&count===countChecked+countDisabled,that.toggleDisabled($checkAll,count===countDisabled)})},toggleSameInGroups:function(dataElement,toggleAll){var that=this,id=dataElement.getAttribute("data-id"),name=dataElement.name||id,checked=dataElement.checked,$actualGroup,$elements,$visibleElements;return toggleAll?($actualGroup=$(dataElement).parents('[data-group="'+name+'"]').first(),$elements=$actualGroup.find('input[data-name="'+name+'"]:not(:disabled)'),$visibleElements=$elements.filter(":visible").each(function(){this.checked=checked,that.toggleDisabled($('[data-group="'+name+'"]').not($actualGroup).find('input[data-id="'+name+":"+this.value+'"]'),checked)})):this.toggleDisabled(this.$actionEl.filter('[data-id="'+id+'"]').not(dataElement),checked),box.publish("splittest.chooseRecipients.checkGroupsStatus",name),!$elements||!$visibleElements||$visibleElements.length&&$visibleElements.length===$elements.length?!1:$visibleElements},toggleDisabled:function($element,disabled){disabled?($element.attr("disabled","disabled"),$element.parent().addClass("disabled")):($element.removeAttr("disabled"),$element.parent().removeClass("disabled"))},actionRefreshCounter:function(){this.counter.dataExpire(),this.counter.refresh()},actionCheckAll:function(e,data){this.actionCheck(e,data,!0)},actionCheck:function(e,data,toggleAll){var that=this,sendData=data.data,dataElement=data.dataElement,$elements,values=[],selectionType;sendData.mode=dataElement.checked?"set":"unset",dataElement.disabled||($elements=this.toggleSameInGroups(dataElement,toggleAll),$.register.counterSelfRefresh||"include"!==sendData.m_type?this.counter.dataExpire():$('input[type="checkbox"][data-action*="include"]:checked')[0]?this.counter.dataExpire():box.publish("splittest.chooseRecipients.slider.setRecipientsData",0),toggleAll&&sendData.selection_type&&(selectionType=sendData.selection_type,$elements&&($elements.each(function(){values.push(this.value)}),sendData[selectionType]=values)),$.post("ajax_split_test_choose_recipients.html"+window.location.search+"&action="+sendData.action,sendData,function(response){response.table&&$.register&&$.register.counterSelfRefresh&&that.counter.refresh()},"json"))}},form={$form:void 0,init:function($form){this.$form=$form},getData:function(){var data={is_automatic:""};return APP.each(this.$form.serializeArray(),function(item){data[item.name]=item.value}),data},save:function(callbackSucces,callbackError){$.post("ajax_split_test_choose_recipients.html?action=save_part&stid="+$.register.stid,this.getData(),function(resoult){resoult.table&&"done"===resoult.table?callbackSucces.call(this,resoult.table):callbackError.call(this,resoult.error)},"json")}},box.subscribe("splittest.chooseRecipients.save",function(callbackSucces,callbackError){form.save(callbackSucces,callbackError)}),box.subscribe("splittest.chooseRecipients.checkGroupsStatus",function(name){recipients.checkGroupsStatus(name)}),APP.domready(function(){Object.create(recipients).init($("[data-action]"),$("[data-counter]")),$.fn&&$.fn.iCheckbox&&$('input[type="checkbox"][data-type="icheckbox"]').each(function(){$(this).iCheckbox(this.checked?"on":"off",{switch_container_src:"/images/core/pages/panel/messagecreator/common/icheckbox/ichecboxswitchborder.png"})}),$("[data-fullselect]").each(function(){var data=this.getAttribute("data-fullselect"),config={mode:!1},$select=$(this);switch(data){case"days":config.afterClickItem=function(){var options=$select[0].options,hours=$("[data-hideHours]"),val=$select.val(),hourSelect=hours.find("select");"0"===val?(hours.removeClass("inactive"),hourSelect[0].disabled=!1,$select.detachedZeroOption||($select.detachedZeroOption=hourSelect.find('option[value="0"]').detach(),hourSelect.trigger("rebuildList").trigger("rebuildValue"))):($select.detachedZeroOption&&(hourSelect.prepend($select.detachedZeroOption),$select.detachedZeroOption=void 0,hourSelect.trigger("rebuildList").trigger("rebuildValue")),val===options[options.length-1].value?(hours.addClass("inactive"),hourSelect.val("0").trigger("selectionChange")[0].disabled=!0):(hours.removeClass("inactive"),hourSelect[0].disabled=!1))}}$select.fullSelectLc(config)}),form.init($("#choose-recipients-form"))})}),APP(function(){"use strict";var box=this,$=box.dom||jQuery,timer,timerWarning,slider,pKey;slider={$body:void 0,$container:void 0,$split:void 0,$winning:void 0,$scroll:void 0,$formElement:void 0,$scrollbar:void 0,$splitPercent:void 0,$winningPercent:void 0,$warning:void 0,$messageData:void 0,startEvent:void 0,showWarning:!0,tmpPercent:0,percent:0,width:960,recipients:0,spRecipients:0,fieldCount:2,minPercent:50,maxPercent:90,init:function($container){return this.$container=$container,this.getDataFromContainer(),this.setMinMaxPercent(this.minPercent,this.maxPercent)&&this.setPercent(this.percent,!0),this.attachEvents(),this},getDataFromContainer:function(){var $container=this.$container,count,reg=$.register;this.$split=$container.find('[data-slider="split"]'),this.$winning=$container.find('[data-slider="winning"]'),this.$scroll=$container.find('[data-slider="scroll"]'),this.$formElement=$container.find('[data-slider="formElement"]'),this.$scrollbar=$container.find("[data-scrollbar]"),this.$splitPercent=$container.find('[data-count="field"]'),this.$winningPercent=$container.find('[data-count="winning"]'),this.$warning=$container.find('[data-slider="warning"]'),this.$messageData=$container.find('[data-slider="messageData"]'),this.$body=$("body"),this.percent=100-Number(this.$scroll.attr("data-percent"))||50,this.width=Number(this.$container.attr("data-width"))||0,count=Number($container.attr("data-count")),reg.formLines&&reg.formLines.length&&(count=reg.formLines.length,$container.attr("data-count",count)),this.fieldCount=count,this.setMessageData()},setMessageData:function(){var $messageData=this.$messageData,reg=$.register,formLines=reg.formLines;formLines&&$messageData.each(function(i){var data=formLines[i],html=[];return data?(APP.each(data,function(el){var structure=reg.formStructure[el.name],value;switch(structure&&structure.values&&(value=structure.values.filter(function(ob){return ob.value===el.value})[0],value=value&&value.text),value=pKey.getItem(value||el.value),el.name){case"subjects":html.push(el.value);break;case"days":case"dates":case"times":case"from_fields_id":html.push(value);break;case"time_zones":html.push("("+value+")")}}),this.innerHTML=html.join(" "),!0):!1})},setMinMaxPercent:function(min,max){var percent=this.percent,ln=this.fieldCount;return min=Math.ceil(Math.max(min,50)),min+=(100-min)%ln,max=Math.floor(Math.min(max,90)),max=max-ln+((100-max)%ln||ln),this.minPercent=min,this.maxPercent=max,this.$scrollbar.css({left:100-this.maxPercent+"%",right:this.minPercent+"%"}),percent=Math.min(Math.max(percent,this.minPercent),this.maxPercent),this.minPercent>=this.maxPercent?(this.minPercent=this.maxPercent=50,percent=50,this.disableScroll()):this.enableScroll(),percent!==this.percent?(this.setPercent(percent,!0),!1):!0},attachEvents:function(){var that=this;this.$scroll.bind({mousedown:function(e){that.mouseDown(e)}})},mouseDown:function(e){var that=this,splitRecipients=this.spRecipients;e.preventDefault(),e.stopPropagation(),this.registerStartEvent(e),splitRecipients&&250>splitRecipients&&!this.showWarning&&this.showAlertToFewRecipients(),this.$body.bind({"mouseup.slider":function(e){that.mouseUp(e)},"mousemove.slider":function(e){that.mouseMove(e)}})},mouseUp:function(e){this.$body.unbind("mouseup.slider").unbind("mousemove.slider"),this.startEvent&&(this.setPercentsByEvent(e),this.startEvent=void 0,this.hideAlertToFewRecipients())},mouseMove:function(e){return e.which?void this.setPercentsByEvent(e):void this.mouseUp(this.startEvent)},registerStartEvent:function(e){this.tmpPercent=this.percent,this.startEvent=e},setPercentsByEvent:function(e){var actualPercent=this.tmpPercent,startEvent=this.startEvent,width=this.width,fieldCount=this.fieldCount,pageX0=this.eventToXY(startEvent).x+actualPercent*width/100,percent=Math.round(100*(pageX0-this.eventToXY(e).x)/width);percent=100-Math.round((100-percent)/fieldCount)*fieldCount,percent=Math.min(Math.max(percent,this.minPercent),this.maxPercent),this.setPercent(percent)},setPercent:function(percent,force){var rPercent=100-percent,splitRPercent=Math.floor(rPercent/this.fieldCount*100)/100;(percent!==this.percent||force)&&(this.percent=percent,percent=100-100*splitRPercent*this.fieldCount/100,rPercent=100-percent,this.$formElement.val(rPercent),this.$scroll.css({right:percent+"%"}),this.$winning.css({width:percent+"%"}),this.$winningPercent.text(percent+" %"),this.$splitPercent.html(splitRPercent>4?splitRPercent+"%":" "),this.$split.css({width:rPercent+"%"}),this.splitRecipients(force))},setRecipients:function(recipients){var fieldCount=this.fieldCount,toFewWarning,showWarning;return this.recipients=recipients,2*fieldCount>recipients?(this.disable(),this.showWarning=!0,void $('[data-warning="to-few"]').toggleClass("show",!1)):(this.enable(),window.clearTimeout(timerWarning),showWarning=250*(2*fieldCount)>recipients,this.showWarning=showWarning,toFewWarning=$('[data-warning="to-few"]').toggleClass("show",showWarning),showWarning&&(timerWarning=window.setTimeout(function(){toFewWarning.removeClass("show")},5e3)),void(this.setMinMaxPercent(50,100*(1-fieldCount/recipients))&&this.splitRecipients(!0)))},splitRecipients:function(warningAutoHide){var recipients=this.recipients,percent=this.percent,splitRecipients;void 0!==recipients&&(this.spRecipients=splitRecipients=Math.floor(recipients*(100-percent)/100/this.fieldCount),this.$container.removeClass("disableRecipients"),this.$split.find("[data-recipients]").text(splitRecipients),this.$winning.find("[data-recipients]").text(recipients-this.fieldCount*splitRecipients),250>splitRecipients&&!this.showWarning?this.showAlertToFewRecipients(warningAutoHide):this.hideAlertToFewRecipients())},recipientsDataExpire:function(){this.recipients=void 0,this.$container.addClass("disableRecipients"),this.enable(),this.setMinMaxPercent(50,90)},disable:function(){$("[data-inactive]").attr("data-inactive","true"),this.disableScroll()},enable:function(){$("[data-inactive]").attr("data-inactive","false"),this.enableScroll()},disableScroll:function(){this.$container.addClass("disableScroll")},enableScroll:function(){this.$container.removeClass("disableScroll")},showAlertToFewRecipients:function(autohide){var that=this;window.clearTimeout(timer),this.$warning.addClass("show"),autohide&&(timer=window.setTimeout(function(){that.hideAlertToFewRecipients()},1500))},hideAlertToFewRecipients:function(){this.$warning.removeClass("show")},eventToXY:function(e){return{x:e.pageX,y:e.pageY}}},APP.i18n((window.location.pathname||document.location.pathname).replace("/","")+"&groups=days"),pKey=box.pKey,box.subscribe("splittest.chooseRecipients.slider.setRecipientsData",function(recipients){slider.setRecipients(recipients)}),box.subscribe("splittest.chooseRecipients.slider.recipientsDataExpire",function(){slider.recipientsDataExpire()}),APP.domready(function(){slider.init($(".slider"))})}),APP(function(){"use strict";function setActions(params){function handler(actions,bindActionName){return function(e,additionalData){var el=e.target||null,dataElem,actionHandler,actionName,data;do actionHandler=el&&el.getAttribute("data-action"),dataElem=el,el=el&&el.parentNode;while(null===actionHandler&&el&&1===el.nodeType);null===actionHandler&&bindActionName&&(actionHandler='{action: "'+bindActionName+'"}',dataElem=this),null!==actionHandler&&(data=JSON.evalToObject(actionHandler),actionName=data.action,data=APP.extend(data,{dataElement:dataElem,container:actionContainer},variables,additionalData||{}),actionName&&actions[actionName]&&(e.stopPropagation(),actions[actionName].call(this,e,data)||e.preventDefault()))}}var actionContainer=$(params.container),actions=params.actions,variables=params.variables,k,action,tmpAction,bindToWrapper;for(k in actions)actions.hasOwnProperty(k)&&(action=actions[k],bindToWrapper=void 0,"function"==typeof action&&(tmpAction=action,action={},action[k]=tmpAction,bindToWrapper=k),$(actionContainer).bind(k,handler(action,bindToWrapper)))}var box=this,$=box.dom||jQuery,container=$(".footer-action");container.find("a").each(function(){this.href+="&messages_id="+$.register.messageDetails[0].id}),box.subscribe("splittest.chooseRecipients.setActions",function(params){setActions(params)}),APP.domready(function(){var pKey=APP().pKey,blocked=!1;void 0!==$.growler&&void 0===$.MyG&&($.MyG=$.growler({position:"bottom right",offset:"0 10 10 0",width:350,appendTo:document.body})),box.subscribe("growler.show",function(text){$.MyG&&$.MyG.show(text)}),setActions({container:".footer-action",actions:{click:{prevStep:function(e,data){blocked||(blocked=!0,data.container.addClass("disabled"),$("#redirect_url").val(data.dataElement.href.attr("href").replace(/^.*\/\/[^\/]+\//,"")),$("#choose_recipients_form").submit())},nextStep:function(e,data){blocked||"true"===data.dataElement.getAttribute("data-inactive")||(blocked=!0,data.container.addClass("disabled"),box.publish("splittest.chooseRecipients.save",function(){$("#redirect_url").val(data.dataElement.href.replace(/^.*\/\/[^\/]+\//,"")),$("#choose_recipients_form").submit()},function(errorData){box.publish("growler.show",pKey.getItem("ModSplitTestError")),blocked=!1,data.container.removeClass("disabled")}))}}}})})}),APP(function(){"use strict";var box=this,instances=[],search,searchParamName="data-search";search={opended:!1,empty:!0,$container:void 0,$search:void 0,$value:void 0,$placeholder:void 0,$items:void 0,$show:void 0,$remove:void 0,$all:void 0,init:function(el){return this.setElements(el)?(this.attachEvents(),this):void 0},setElements:function(el){var $el,items,that=this;return items=[],this.$container=$el=$(el),$el.find("["+searchParamName+"]").each(function(){var searchParam=this.getAttribute(searchParamName),$this=$(this);switch(searchParam){case"item":items.push(that.getItem(this));break;default:that["$"+searchParam]=$this}}),this.$items=$(items),!!this.$search},getItem:function(element){return $(element).find("["+searchParamName+"]").each(function(){var searchParam=this.getAttribute(searchParamName);switch(searchParam){case"input":element.searchInput=this;break;case"label":element.searchLabel=this}}),element},attachEvents:function(){var that=this,tout;this.$show.bind({click:function(e){e.preventDefault(),that.open(),that.$container.is(".active")&&e.stopPropagation()}}),this.$remove.bind({click:function(e){e.stopPropagation(),e.preventDefault(),that.$value.val(""),that.narrowDown(""),that.deactivate()}}),this.$placeholder.bind({click:function(e){e.stopPropagation(),e.preventDefault(),that.$value.focus()}}),this.$value.unbind().bind({click:function(e){e.stopPropagation(),e.preventDefault()},keydown:function(e){that.activate()},keyup:function(){var value=this.value;window.clearTimeout(tout),value?tout=window.setTimeout(function(){that.narrowDown(value)},700):(that.deactivate(),that.narrowDown(value))}}),$("body").bind({click:function(){that.empty&&that.close()}})},open:function(){this.$search.addClass("open"),this.$value.focus()},close:function(){this.$search.removeClass("open"),this.$value.blur()},activate:function(){this.empty=!1,this.$search.addClass("act")},deactivate:function(){this.empty=!0,this.$search.removeClass("act")},setHeight:function(){var $container=this.$container,$sectionIn=$container.find(".jsSectionIn"),height=$sectionIn.outerHeight();this.$container.css({height:height+"px"}).find("[end-height]").attr("end-height",height)},narrowDown:function(value,skipCallback){var regexp,searchInput;if(value=value.replace(/([\\\^\$\*\+\?\.\{\}\[\]\(\)])/g,"\\$1").trim(),!value)return this.$items.show(),this.setHeight(),void(skipCallback||this.$items.each(function(){var label=this.searchLabel;if(this.searchInput&&label&&!this.searchInput.checked)return box.publish("splittest.chooseRecipients.checkGroupsStatus",this.searchInput.name),!1}));try{regexp=new RegExp(value,"i")}catch(e){return}this.$items.each(function(){var text,label=this.searchLabel;this.searchInput&&label&&!this.searchInput.checked&&(searchInput=this.searchInput,text=label.textContent||label.innerText,regexp.test(text)?$(this).show():$(this).hide())}),searchInput&&!skipCallback&&box.publish("splittest.chooseRecipients.checkGroupsStatus",searchInput.name),this.setHeight()},refresh:function(){this.narrowDown(this.$value.val(),!0)}},box.subscribe("splittest.chooseRecipients.checkGroupsStatus",function(){instances.forEach(function(instance){instance.refresh()})}),$(function(){$("["+searchParamName+'="container"]').each(function(){var instance=Object.create(search).init(this);instance&&instances.push()}),$(".steps a").click(function(e){e.preventDefault(),$("#redirect_url").val($(this).attr("href").replace(/^.*\/\/[^\/]+\//,"")),$("#choose_recipients_form").submit()})})});